{% extends 'msys42app/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid" style="min-height: 100vh; display: flex; justify-content: center; align-items: center;">
    <div class="card p-5" style="border-radius: 20px; width: 100%; max-width: 1500px;">
        <h2 class="text-center mb-4">Edit Child Profile</h2>
        <h6 class="text-center mb-4"> Fields with red asterisks <span class="required" style="color: red;">*</span> are required </h6>

        <form method="POST" action="{% url 'edit_child_profile' pk=child.pk %}" style="font-weight: bolder;">
            {% csrf_token %}

            {% if error_message_var %}
            <a style="color:red">{{ error_message_var }}</a>
            {% endif %}

            <div class="row mb-3">
               
                <div class="col-md-2">
                    <label for="code">SPC Code <span class="required" style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="code" name="code" maxlength="7" minlength="7" pattern="[A-Z]{3}[0-9]{4}" value="{{ child.code }}" placeholder="AAA1234">
                </div>

                <div class="col-md-3">
                    <label for="lastname">Last Name <span class="required" style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="lastname" name="lastname" maxlength="25" value="{{ child.lastname }}" required>
                </div>

                <div class="col-md-3">
                    <label for="firstname">First Name <span class="required" style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="firstname" name="firstname" maxlength="50" value="{{ child.firstname }}" required>
                </div>

                <div class="col-md-3">
                    <label for="middlename">Middle Name</label>
                    <input type="text" class="form-control" id="middlename" name="middlename" maxlength="25" value="{{ child.middlename }}">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="sex">Sex <span class="required" style="color: red;">*</span></label>
                    <select class="form-control" id="sex" name="sex" value="{{ child.sex }}" required>
                        <option value="{{ child.sex }}"> {{ child.sex }} </option>
                        <option value="Female">Female</option>
                        <option value="Male">Male</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="birth">Date of Birth <span class="required" style="color: red;">*</span></label>
                    <input type="date" class="form-control" id="birth" name="birth" value="{{ child.birth|date:'Y-m-d' }}" required>
                </div>
                
                <div class="col-md-3">
                    <label for="blood_group">Blood Group</label>
                    <select class="form-control" id="blood_group" name="blood_group" value="{{ child.blood_group }}">
                        <option value="{{ child.blood_group }}"> {{ child.blood_group }} </option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="address">Communication Address <span class="required" style="color: red;">*</span></label>
                <input type="text" class="form-control" id="address" name="address" maxlength="255" value="{{ child.address }}" required>
            </div>

        
            <div class="row mb-3">
                <div class="col-md-5">
                    <label for="philhealth">Family PhilHealth Number</label>
                    <input type="text" class="form-control" id="philhealth" name="philhealth" pattern="[0-9]{2}-[0-9]{9}-[0-9]{1}"   value="{{ child.philhealth }}" placeholder="12-123456789-1" maxlength="14">
                </div>
                <div class="col-md-5">
                    <label for="fourps">Family 4Ps Number</label>
                    <input type="text" class="form-control" id="fourps" name="fourps" maxlength="20" value="{{ child.fourps }}" placeholder="123412341234">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="guardian_lastname">Guardian's Last Name <span class="required" style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="guardian_lastname" name="guardian_lastname" value="{{ child.guardian_lastname }}" required>
                </div>
                <div class="col-md-4">
                    <label for="guardian_firstname">Guardian's First Name <span class="required" style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="guardian_firstname" name="guardian_firstname" value="{{ child.guardian_firstname }}" required>
                </div>
                <div class="col-md-4">
                    <label for="guardian_middlename">Guardian's Middle Name</label>
                    <input type="text" class="form-control" id="guardian_middlename" name="guardian_middlename" value="{{ child.guardian_middlename }}">
                </div>
                <div class="col-md-4">
                    <label for="guardian_sex">Guardian's Sex <span class="required" style="color: red;">*</span></label>
                    <select class="form-control" id="guardian_sex" name="guardian_sex" value="{{ child.guardian_sex }}" required>
                        <option value="{{ child.guardian_sex }}"> {{ child.guardian_sex }} </option>
                        <option value="Female">Female</option>
                        <option value="Male">Male</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="relationship">Guardian's Relationship to SPC <span class="required" style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="relationship" name="relationship" value="{{ child.guardian_relationship }}" required>
                </div>
            </div>

            <div class="mb-3" style="width: 300px; align-self: left;">
                <label for="contact_number[]">Contact Number <span class="required" style="color: red;">*</span></label>
                <div id="contact-numbers">
                    {% for contact in contacts %}
                    <div class="d-flex mb-2">
                        <input type="tel" name="contact_number[]" class="form-control" pattern="09[0-9]{9}" placeholder="09*********" value="{{ contact.number }}" maxlength="11" required>
                        {% if forloop.first %}
                        <button type="button" class="btn btn-success ms-2" id="addContact">+</button>
                        {% else %}
                        <button type="button" class="btn btn-danger ms-2 removeContact">-</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
             
            


            <div class="text-left">
                <button type="submit" class="btn btn-success"> Save </button>
                <a href="{% url 'view_child_profile' pk=child.pk%}" class="btn btn-secondary" onclick="return confirmCancel();">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    function ContactButton() {
        let contactDiv = document.createElement('div');
        contactDiv.classList.add('d-flex', 'mb-2');

        let input = document.createElement('input');
        input.type = 'tel';
        input.classList.add('form-control');
        input.name = 'contact_number[]';
        input.placeholder = '09*********';
        input.required = true;
        input.maxLength = 11;
        input.pattern = "09[0-9]{9}";

        let removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.classList.add('btn', 'btn-danger', 'ms-2', 'removeContact');
        removeBtn.textContent = '-';

        removeBtn.addEventListener('click', function () {
            contactDiv.remove();
        });

        contactDiv.appendChild(input);
        contactDiv.appendChild(removeBtn);
        document.getElementById('contact-numbers').appendChild(contactDiv);

        input.addEventListener('input', checkDuplicateContacts);
    }

    function checkDuplicateContacts() {
        let contactInputs = document.querySelectorAll('input[name="contact_number[]"]');
        let values = new Set();
        let hasDuplicates = false;

        contactInputs.forEach(input => {
            if (values.has(input.value)) {
                input.setCustomValidity("Duplicate contact number found!");
                hasDuplicates = true;
            } else {
                input.setCustomValidity("");
                values.add(input.value);
            }
        });
        return !hasDuplicates;
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('addContact').addEventListener('click', ContactButton);

        document.getElementById('contact-numbers').addEventListener('click', function (event) {
            if (event.target.classList.contains('removeContact')) {
                event.target.closest('.d-flex').remove();
            }
        });

        document.getElementById('contact-numbers').addEventListener('input', checkDuplicateContacts);

        document.querySelector("form").addEventListener("submit", function (event) {
            if (!checkDuplicateContacts()) {
                event.preventDefault();
                alert("Duplicate contact number found");
            }
        });
    });

    function confirmCancel() {
        return confirm("Cancel entry? The information will be lost.");
    }
</script>

{% endblock %}
